"""
    ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
    Copyright (C) 2025  Theori Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Expo assessor for CVE-2025-55182."""

from typing import Any, Dict, Optional

from ...models.poc import PocStatus
from ..interpreters import analyze_multi_action_results
from ..journal import PocJournal
from ..payloads import (
    generate_action_ids,
    run_action_probes,
    send_json_action_probe,
    send_json_control_probe,
)
from .base import BaseAssessor


class ExpoAssessor(BaseAssessor):
    framework_name = "expo"

    def evaluate(
        self,
        base_url: str,
        detected_versions: Dict[str, Any],
        detect_context: Optional[Dict] = None,
        proxy_profile: Optional[str] = None,
        correlation_id: Optional[str] = None,
    ) -> Dict[str, Any]:
        journal = PocJournal()
        signals = (detect_context or {}).get("signals", {}) or {}
        server_actions_signal = signals.get("server_actions_enabled")
        if server_actions_signal is None and not signals.get("rsc_endpoint_found"):
            server_actions_signal = False
        is_rsc_framework = bool(signals.get("rsc_endpoint_found"))
        react_major_confidence = (detect_context or {}).get(
            "react_major_confidence"
        ) or self.get_version_confidence("react_version", detected_versions, detect_context)

        if server_actions_signal is False and is_rsc_framework:
            # Treat missing server-action signal on RSC frameworks as unknown to allow probing.
            server_actions_signal = None

        if server_actions_signal is False:
            reason = "Server actions not detected by framework probe (Expo RSC-only)"
            journal.add_decision(PocStatus.NOT_VULNERABLE, reason)
            return self.build_not_applicable_result(
                reason,
                detected_versions,
                surface_detected=signals.get("rsc_endpoint_found", False),
                not_affected=True,
                journal=journal,
                confidence=signals.get("server_actions_confidence")
                or signals.get("detection_confidence_level")
                or "medium",
            )

        action_ids = generate_action_ids(3)
        http_client = (detect_context or {}).get("http_client") if detect_context else None
        action_urls = (detect_context or {}).get("server_action_endpoints") if detect_context else None
        probe_results, control_result, error_categories = run_action_probes(
            base_url,
            action_ids,
            action_probe=send_json_action_probe,
            control_probe=send_json_control_probe,
            proxy_profile=proxy_profile,
            correlation_id=correlation_id,
            action_urls=action_urls,
            control_url=action_urls[0] if action_urls else None,
            http_client=http_client,
        )

        analysis = analyze_multi_action_results(
            probe_results,
            action_ids=action_ids,
            framework=self.framework_name,
            is_rsc_framework=is_rsc_framework,
            error_categories=error_categories,
            control_results=[control_result],
            react_major=self.get_react_major(detected_versions, detect_context),
            react_major_confidence=react_major_confidence,
            server_actions_expected=(
                server_actions_signal if server_actions_signal is not None else True
            ),
            server_actions_confidence=signals.get("server_actions_confidence"),
            journal=journal,
        )

        analysis["details"]["detected_versions"] = detected_versions
        return analysis
