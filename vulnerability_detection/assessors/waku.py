"""
    ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
    Copyright (C) 2025  Theori Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Waku assessor for CVE-2025-55182."""

import secrets
from typing import Any, Dict, List, Optional, Set, Tuple
from urllib.parse import urljoin

from ...framework_detection.signals.waku import probe_waku_server_actions
from ..constants import MAX_WAKU_PROBE_ENDPOINTS
from ..interpreters import analyze_waku_results
from ..journal import PocJournal
from ..payloads import send_waku_probe
from .base import BaseAssessor


class WakuAssessor(BaseAssessor):
    framework_name = "waku"

    def evaluate(
        self,
        base_url: str,
        detected_versions: Dict[str, Any],
        detect_context: Optional[Dict] = None,
        proxy_profile: Optional[str] = None,
        correlation_id: Optional[str] = None,
    ) -> Dict[str, Any]:
        journal = PocJournal()
        signals = (detect_context or {}).get("signals", {}) or {}
        react_version = detected_versions.get("react_version") or detected_versions.get(
            "detected_react_version"
        )
        react_major_confidence = (detect_context or {}).get(
            "react_major_confidence"
        ) or self.get_version_confidence("react_version", detected_versions, detect_context)

        probe = probe_waku_server_actions(
            base_url,
            proxy_profile=proxy_profile,
            correlation_id=correlation_id,
        )

        endpoints: List[Tuple[str, str]] = []
        has_actions = False
        http_client = (detect_context or {}).get("http_client") if detect_context else None
        if isinstance(probe, tuple):
            has_actions = bool(probe[0])
            if len(probe) >= 3 and isinstance(probe[2], list):
                endpoints = [(urljoin(base_url, ep[0]), ep[1]) for ep in probe[2]]
        else:
            has_actions = bool(probe)

        if not has_actions or not endpoints:
            return self.build_not_applicable_result(
                "No Waku server action endpoints found",
                detected_versions,
                surface_detected=False,
                confidence=signals.get("detection_confidence_level") or "medium",
            )

        # Limit probes to avoid excessive requests
        endpoints_to_probe = endpoints[:MAX_WAKU_PROBE_ENDPOINTS]
        probe_results = []
        error_categories: Set[str] = set()

        control_results = []

        for endpoint_url, action_name in endpoints_to_probe:
            proto_result = send_waku_probe(
                endpoint_url,
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
                target_prop="__proto__",
                http_client=http_client,
            )
            control_result = send_waku_probe(
                endpoint_url,
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
                target_prop=f"z{secrets.token_hex(4)}",
                http_client=http_client,
            )
            for res in (proto_result, control_result):
                res["endpoint"] = endpoint_url
                res["action_name"] = action_name
                if not res.get("ok") and res.get("error_category"):
                    error_categories.add(res.get("error_category"))

            probe_results.append(proto_result)
            control_results.append(control_result)

        analysis = analyze_waku_results(
            probe_results,
            endpoints=endpoints_to_probe,
            control_results=control_results,
            react_major=self.get_react_major(detected_versions, detect_context),
            react_version=react_version,
            react_major_confidence=react_major_confidence,
            journal=journal,
        )

        analysis["details"]["detected_versions"] = detected_versions
        return analysis
