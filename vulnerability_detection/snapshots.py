from __future__ import annotations

"""
    ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
    Copyright (C) 2025  Theori Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Detection snapshot utilities shared by vulnerability assessors."""

from dataclasses import dataclass
from typing import Any, Dict, Optional

from ..http.client import HttpClient
from ..models import FrameworkDetectionResult
from ..utils.version import parse_semver


@dataclass
class DetectionSnapshot:
    """Normalized view of framework detection output for downstream assessors."""

    tags: list[str]
    signals: Dict[str, Any]
    detected_versions: Dict[str, Any]
    react_major: Optional[int]
    react_major_confidence: Optional[str]
    server_actions_enabled: Optional[bool]
    server_actions_confidence: Optional[str]
    server_action_endpoints: list[str]

    @classmethod
    def from_detection(cls, detection: FrameworkDetectionResult) -> "DetectionSnapshot":
        signals = detection.signals or {}
        tags = list(detection.tags or [])

        detected_versions = {
            key.replace("detected_", ""): value
            for key, value in signals.items()
            if key.startswith("detected_")
        }

        react_major = cls._resolve_react_major(signals, detected_versions)
        react_major_confidence = cls._resolve_react_major_confidence(signals, detected_versions)
        server_actions_enabled = signals.get("server_actions_enabled")
        server_actions_confidence = signals.get("server_actions_confidence")
        server_action_endpoints = list(signals.get("server_action_endpoints") or [])

        return cls(
            tags=tags,
            signals=signals,
            detected_versions=detected_versions,
            react_major=react_major,
            react_major_confidence=react_major_confidence,
            server_actions_enabled=server_actions_enabled,
            server_actions_confidence=server_actions_confidence,
            server_action_endpoints=server_action_endpoints,
        )

    @staticmethod
    def _resolve_react_major(signals: Dict[str, Any], versions: Dict[str, Any]) -> Optional[int]:
        if signals.get("detected_react_major") is not None:
            try:
                return int(signals["detected_react_major"])
            except (TypeError, ValueError):
                return None

        if versions.get("react_major") is not None:
            try:
                return int(versions["react_major"])
            except (TypeError, ValueError):
                return None

        if versions.get("react_version"):
            parsed = parse_semver(str(versions["react_version"]))
            if parsed:
                return parsed.major

        return None

    @staticmethod
    def _resolve_react_major_confidence(
        signals: Dict[str, Any], versions: Dict[str, Any]
    ) -> Optional[str]:
        if signals.get("detected_react_major_confidence"):
            return signals.get("detected_react_major_confidence")

        if versions.get("react_major_confidence"):
            return versions.get("react_major_confidence")

        if versions.get("react_version_confidence"):
            return versions.get("react_version_confidence")

        return None

    def to_detect_context(self, http_client: Optional[HttpClient] = None) -> Dict[str, Any]:
        """Backwards compatible detect_context mapping consumed by evaluators."""
        return {
            "react_major": self.react_major,
            "react_major_confidence": self.react_major_confidence,
            "server_actions_enabled": self.server_actions_enabled,
            "server_actions_confidence": self.server_actions_confidence,
            "signals": self.signals,
            "tags": self.tags,
            "server_action_endpoints": self.server_action_endpoints,
            "http_client": http_client,
        }
