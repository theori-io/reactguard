"""
    ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
    Copyright (C) 2025  Theori Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Waku RSC probe for CVE-2025-55182."""

import secrets
from typing import Any, Dict, Optional

from ...config import load_http_settings
from ..http import scan_with_retry


def _user_agent() -> str:
    return load_http_settings().user_agent


def send_waku_probe(
    endpoint: str,
    proxy_profile: Optional[str] = None,
    correlation_id: Optional[str] = None,
    http_client=None,
    target_prop: str = "__proto__",
) -> Dict[str, Any]:
    boundary = f"----FormBoundary{secrets.token_hex(8)}"
    chunk1 = '{"x":{}}'
    args = f'["$1:x:{target_prop}"]'

    body = (
        f"--{boundary}\r\n"
        f'Content-Disposition: form-data; name="1"\r\n\r\n{chunk1}\r\n'
        f"--{boundary}\r\n"
        f'Content-Disposition: form-data; name="0"\r\n\r\n{args}\r\n'
        f"--{boundary}--\r\n"
    )

    headers = {
        "Content-Type": f"multipart/form-data; boundary={boundary}",
        "Accept": "text/x-component",
        "User-Agent": _user_agent(),
    }

    scan = scan_with_retry(
        endpoint,
        method="POST",
        headers=headers,
        body=body,
        proxy_profile=proxy_profile,
        correlation_id=correlation_id,
        http_client=http_client,
    )

    if not scan.get("ok"):
        return {
            "error": scan.get("error_message"),
            "error_category": scan.get("error_category"),
            "error_type": scan.get("error_type"),
        }

    return scan
