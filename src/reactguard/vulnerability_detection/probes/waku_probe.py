"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Waku RSC probe for CVE-2025-55182."""

import json
from typing import Any

from ...rsc.payloads import NO_INVOKE_FORCE_FAIL_TRAILER_STRATEGY, RscReference, build_multipart_form_payload
from ...rsc.send import send_rsc_request
from ...rsc.types import RscHttpResult, RscRequestConfig

_FORCE_FAIL_TRAILER = ("reactguard_missing", "probe")


def _send_waku_probe_ctx(
    endpoint: str,
    *,
    target_prop: str = "__proto__",
    force_fail: bool = False,
) -> RscHttpResult:
    reference = RscReference(
        slot=1,
        root="x",
        prop=target_prop,
        marker="",
        trailer=_FORCE_FAIL_TRAILER if force_fail else (),
    )
    ref_str = reference.render()
    root_object: dict[str, Any] = {reference.root: {}}
    payload = build_multipart_form_payload(
        [
            ("1", json.dumps(root_object, separators=(",", ":"))),
            ("0", json.dumps([ref_str], separators=(",", ":"))),
        ],
        meta={
            "probe_strategy": NO_INVOKE_FORCE_FAIL_TRAILER_STRATEGY if force_fail else "waku_decode_payload",
            "reference": ref_str,
        },
    )
    request_config = RscRequestConfig(
        method="POST",
        base_headers={"Accept": "text/x-component"},
        action_id_header=None,
    )
    return send_rsc_request(endpoint, request_config, payload)


def send_waku_probe(
    endpoint: str,
    target_prop: str = "__proto__",
    force_fail: bool = False,
) -> RscHttpResult:
    return _send_waku_probe_ctx(endpoint, target_prop=target_prop, force_fail=force_fail)
