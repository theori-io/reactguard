# SPDX-FileCopyrightText: 2025 Theori Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later

"""Waku RSC probe for CVE-2025-55182."""

import json
from typing import Any

from ...rsc.payloads import NO_INVOKE_FORCE_FAIL_TRAILER_STRATEGY, RscReference, build_multipart_form_payload
from ...rsc.send import send_rsc_request
from ...rsc.types import RscHttpResult, RscRequestConfig

_FORCE_FAIL_TRAILER = ("reactguard_missing", "probe")


def _send_waku_probe_ctx(
    endpoint: str,
    *,
    target_prop: str = "__proto__",
    force_fail: bool = False,
) -> RscHttpResult:
    reference = RscReference(
        slot=1,
        root="x",
        prop=target_prop,
        marker="",
        trailer=_FORCE_FAIL_TRAILER if force_fail else (),
    )
    ref_str = reference.render()
    root_object: dict[str, Any] = {reference.root: {}}
    payload = build_multipart_form_payload(
        [
            ("1", json.dumps(root_object, separators=(",", ":"))),
            ("0", json.dumps([ref_str], separators=(",", ":"))),
        ],
        meta={
            "probe_strategy": NO_INVOKE_FORCE_FAIL_TRAILER_STRATEGY if force_fail else "waku_decode_payload",
            "reference": ref_str,
        },
    )
    request_config = RscRequestConfig(
        method="POST",
        base_headers={"Accept": "text/x-component"},
        action_id_header=None,
    )
    return send_rsc_request(endpoint, request_config, payload)


def send_waku_probe(
    endpoint: str,
    target_prop: str = "__proto__",
    force_fail: bool = False,
) -> RscHttpResult:
    return _send_waku_probe_ctx(endpoint, target_prop=target_prop, force_fail=force_fail)
