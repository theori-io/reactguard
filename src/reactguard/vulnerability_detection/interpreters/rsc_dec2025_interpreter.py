from __future__ import annotations

"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Dec 2025 CVE mapping logic from a patch-fingerprint outcome."""

from dataclasses import dataclass
from typing import Any, Literal

from ...models.poc import PocStatus
from ..journal import PocJournal

Dec2025CveId = Literal["CVE-2025-55184", "CVE-2025-67779", "CVE-2025-55183"]
PatchFingerprint = Literal["pre_35345", "post_35345_pre_35351", "post_35351"]
PatchFingerprintWithUnknown = PatchFingerprint | Literal["post_35345_unknown"]


@dataclass(frozen=True)
class RscDec2025Interpreter:
    """
    Interpreter for the Dec 2025 CVE family.

    This is intentionally CVE- and framework-aware (cve_id, framework tuple) so callers can
    keep transport/probing separate from verdict mapping.
    """

    cve_id: Dec2025CveId
    framework: str

    def to_report(
        self,
        *,
        patch_fingerprint: PatchFingerprintWithUnknown | None,
        detected_versions: dict[str, Any],
        evidence: dict[str, Any],
        journal: PocJournal,
        server_actions_enabled: bool | None,
        server_actions_confidence: str | None,
    ) -> dict[str, Any]:
        if patch_fingerprint is None:
            return {
                "status": PocStatus.INCONCLUSIVE,
                "details": {
                    "cve_id": self.cve_id,
                    "confidence": "low",
                    "reason": "Could not fingerprint Dec 2025 patch level on a reachable decode surface",
                    "patch_fingerprint": None,
                    "detected_versions": detected_versions,
                    "framework_detected": self.framework,
                },
                "raw_data": {"evidence": evidence, "journal": journal.to_list()},
            }

        if self.cve_id == "CVE-2025-55184":
            if patch_fingerprint == "pre_35345":
                return {
                    "status": PocStatus.VULNERABLE,
                    "details": {
                        "cve_id": self.cve_id,
                        "confidence": "high",
                        "reason": "Target appears pre-PR#35345 (missing initial RSC DoS mitigation)",
                        "patch_fingerprint": patch_fingerprint,
                        "detected_versions": detected_versions,
                        "framework_detected": self.framework,
                    },
                    "raw_data": {"evidence": evidence, "journal": journal.to_list()},
                }
            return {
                "status": PocStatus.NOT_VULNERABLE,
                "details": {
                    "cve_id": self.cve_id,
                    "confidence": "high",
                    "reason": "Target appears to include PR#35345 (initial DoS mitigation present)",
                    "patch_fingerprint": patch_fingerprint,
                    "detected_versions": detected_versions,
                    "framework_detected": self.framework,
                },
                "raw_data": {"evidence": evidence, "journal": journal.to_list()},
            }

        if self.cve_id == "CVE-2025-67779":
            if patch_fingerprint == "pre_35345":
                return {
                    "status": PocStatus.NOT_APPLICABLE,
                    "details": {
                        "cve_id": self.cve_id,
                        "confidence": "high",
                        "reason": "Target appears vulnerable to CVE-2025-55184; CVE-2025-67779 applies to incomplete-fix versions only",
                        "patch_fingerprint": patch_fingerprint,
                        "detected_versions": detected_versions,
                        "framework_detected": self.framework,
                        "not_affected": True,
                    },
                    "raw_data": {"evidence": evidence, "journal": journal.to_list()},
                }
            if patch_fingerprint == "post_35345_unknown":
                return {
                    "status": PocStatus.INCONCLUSIVE,
                    "details": {
                        "cve_id": self.cve_id,
                        "confidence": "medium",
                        "reason": "Target appears to include PR#35345, but the PR#35351 fingerprint is inconclusive on this endpoint",
                        "patch_fingerprint": patch_fingerprint,
                        "detected_versions": detected_versions,
                        "framework_detected": self.framework,
                    },
                    "raw_data": {"evidence": evidence, "journal": journal.to_list()},
                }
            if patch_fingerprint == "post_35351":
                return {
                    "status": PocStatus.NOT_VULNERABLE,
                    "details": {
                        "cve_id": self.cve_id,
                        "confidence": "high",
                        "reason": "Target appears to include PR#35351 (cycleProtection guard present)",
                        "patch_fingerprint": patch_fingerprint,
                        "detected_versions": detected_versions,
                        "framework_detected": self.framework,
                    },
                    "raw_data": {"evidence": evidence, "journal": journal.to_list()},
                }
            return {
                "status": PocStatus.VULNERABLE,
                "details": {
                    "cve_id": self.cve_id,
                    "confidence": "high",
                    "reason": "Target appears to include PR#35345 but not PR#35351 (incomplete DoS fix)",
                    "patch_fingerprint": patch_fingerprint,
                    "detected_versions": detected_versions,
                    "framework_detected": self.framework,
                },
                "raw_data": {"evidence": evidence, "journal": journal.to_list()},
            }

        # CVE-2025-55183 (source exposure) is configuration-dependent, but fixed by PR#35345.
        if patch_fingerprint != "pre_35345":
            return {
                "status": PocStatus.NOT_VULNERABLE,
                "details": {
                    "cve_id": self.cve_id,
                    "confidence": "high",
                    "reason": "Target appears to include PR#35345 (server reference source-hiding present)",
                    "patch_fingerprint": patch_fingerprint,
                    "detected_versions": detected_versions,
                    "framework_detected": self.framework,
                },
                "raw_data": {"evidence": evidence, "journal": journal.to_list()},
            }

        if server_actions_enabled is False and str(server_actions_confidence or "").lower() == "high":
            return {
                "status": PocStatus.NOT_APPLICABLE,
                "details": {
                    "cve_id": self.cve_id,
                    "confidence": "high",
                    "reason": "No Server Functions surface detected (CVE requires a Server Function that stringifies attacker-controlled input)",
                    "patch_fingerprint": patch_fingerprint,
                    "detected_versions": detected_versions,
                    "framework_detected": self.framework,
                    "surface_detected": False,
                    "not_affected": True,
                },
                "raw_data": {"evidence": evidence, "journal": journal.to_list()},
            }

        return {
            "status": PocStatus.LIKELY_VULNERABLE,
            "details": {
                "cve_id": self.cve_id,
                "confidence": "high",
                "reason": "Target appears pre-PR#35345; exploitation still depends on Server Function behavior (explicit/implicit stringify)",
                "patch_fingerprint": patch_fingerprint,
                "server_actions_enabled": server_actions_enabled,
                "server_actions_confidence": server_actions_confidence,
                "detected_versions": detected_versions,
                "framework_detected": self.framework,
            },
            "raw_data": {"evidence": evidence, "journal": journal.to_list()},
        }


__all__ = [
    "Dec2025CveId",
    "PatchFingerprint",
    "PatchFingerprintWithUnknown",
    "RscDec2025Interpreter",
]
