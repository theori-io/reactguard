# SPDX-FileCopyrightText: 2025 Theori Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later

from __future__ import annotations

from ...framework_detection.keys import SIG_INVOCATION_ENABLED, SIG_REACT_ROUTER_SERVER_ACTION_IDS
from ...utils.actions import generate_action_id
from .cache import cache_key, resolver_cache
from .types import ActionEndpoint, ActionResolution
from ..snapshots import DetectContext


def _first_str(values: object) -> str | None:
    if not isinstance(values, list) or not values:
        return None
    first = str(values[0] or "").strip()
    return first or None


def resolve_react_router_action_context(
    base_url: str,
    detect_context: DetectContext | None,
) -> ActionResolution | None:
    """
    Resolve React Router Server Function probing context.

    React Router uses:
    - header `rsc-action-id: <id>`
    - multipart prefix part `1_$ACTION_ID_<id>=""`
    """
    if not base_url:
        return None

    cache = resolver_cache()
    ck = cache_key("react_router_action_ctx", str(base_url))
    cached = cache.get(ck)
    if isinstance(cached, ActionResolution):
        return cached

    action_urls = detect_context.invocation_endpoints if detect_context else []
    endpoints = [str(u) for u in action_urls if u] or [str(base_url)]
    endpoint_objs = [ActionEndpoint(url=endpoint) for endpoint in list(dict.fromkeys(endpoints))]

    signals = detect_context.signals if detect_context else {}
    discovered_id = _first_str(signals.get(SIG_REACT_ROUTER_SERVER_ACTION_IDS))

    synthetic = False
    action_id = discovered_id
    if not action_id:
        action_id = generate_action_id()
        synthetic = True

    prefix_parts = [(f"1_$ACTION_ID_{action_id}", "")]
    out = ActionResolution(
        endpoints=endpoint_objs,
        entrypoint_url=str(base_url),
        discovery_method="detect_context" if action_urls else "base_url",
        has_actions=(detect_context.invocation_enabled if detect_context else None),
        action_id=action_id,
        prefix_parts=prefix_parts,
        synthetic_action_id=synthetic,
        evidence={
            "invocation_enabled": signals.get(SIG_INVOCATION_ENABLED),
            "discovered_action_id": discovered_id,
        },
    )
    cache[ck] = out
    return out


__all__ = ["resolve_react_router_action_context"]
