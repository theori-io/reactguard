"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Generic RSC assessor for CVE-2025-55182."""

from typing import Any

from ...models.poc import PocStatus
from ..interpreters import analyze_multi_action_results
from ..journal import PocJournal
from ..payloads import (
    generate_action_ids,
    run_action_probes,
    send_control_probe,
    send_proto_probe,
)
from .base import BaseAssessor


class GenericRSCAssessor(BaseAssessor):
    framework_name = "rsc"

    def evaluate(
        self,
        base_url: str,
        detected_versions: dict[str, Any],
        detect_context: dict | None = None,
        proxy_profile: str | None = None,
        correlation_id: str | None = None,
    ) -> dict[str, Any]:
        journal = PocJournal()
        action_ids = generate_action_ids(3)
        server_actions_expected = detect_context.get("server_actions_enabled") if detect_context else None
        server_actions_confidence = (detect_context or {}).get("server_actions_confidence") if detect_context else None
        react_major_confidence = (detect_context or {}).get("react_major_confidence") or self.get_version_confidence("react_version", detected_versions, detect_context)
        http_client = (detect_context or {}).get("http_client") if detect_context else None
        action_urls = (detect_context or {}).get("server_action_endpoints") if detect_context else None
        probe_results, control_result, error_categories = run_action_probes(
            base_url,
            action_ids,
            action_probe=send_proto_probe,
            control_probe=send_control_probe,
            proxy_profile=proxy_profile,
            correlation_id=correlation_id,
            action_urls=action_urls,
            control_url=action_urls[0] if action_urls else None,
            http_client=http_client,
        )

        analysis = analyze_multi_action_results(
            probe_results,
            action_ids=action_ids,
            framework=self.framework_name,
            is_rsc_framework=True,
            error_categories=error_categories,
            control_results=[control_result],
            react_major=self.get_react_major(detected_versions, detect_context),
            server_actions_expected=server_actions_expected,
            server_actions_confidence=server_actions_confidence,
            react_major_confidence=react_major_confidence,
            journal=journal,
        )

        analysis["details"]["detected_versions"] = detected_versions
        if analysis["status"] in (PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE):
            confirmation = self._run_confirmation_round(
                base_url,
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
                detect_context=detect_context,
                react_major=self.get_react_major(detected_versions, detect_context),
                react_version=detected_versions.get("react_version"),
                server_actions_expected=server_actions_expected,
                server_actions_confidence=server_actions_confidence,
                react_major_confidence=react_major_confidence,
                action_urls=action_urls,
            )
            if confirmation:
                analysis.setdefault("raw_data", {})["confirmation"] = confirmation.get("raw_data")
                analysis["details"]["confirmation"] = {
                    "status": confirmation["status"],
                    "confidence": confirmation["details"].get("confidence"),
                }
                if confirmation["status"] == analysis["status"]:
                    analysis["details"]["confirmed"] = True
                    analysis["details"]["confidence"] = self._raise_confidence(analysis["details"].get("confidence"))
                else:
                    analysis["details"]["confirmed"] = False
                    analysis["details"]["confidence"] = self._lower_confidence(analysis["details"].get("confidence"))
                    analysis["status"] = PocStatus.LIKELY_VULNERABLE
                    analysis["details"]["reason"] = analysis["details"].get("reason") or "Vulnerability signal not consistent across confirmation round"
        return analysis

    def _run_confirmation_round(
        self,
        base_url: str,
        *,
        proxy_profile: str | None,
        correlation_id: str | None,
        detect_context: dict | None,
        react_major: int | None,
        react_version: str | None,
        server_actions_expected: bool | None,
        server_actions_confidence: str | None,
        react_major_confidence: str | None,
        action_urls: list[str] | None,
    ) -> dict[str, Any] | None:
        confirm_ids = generate_action_ids(2)
        http_client = (detect_context or {}).get("http_client") if detect_context else None
        try:
            probe_results, control_result, error_categories = run_action_probes(
                base_url,
                confirm_ids,
                action_probe=send_proto_probe,
                control_probe=send_control_probe,
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
                action_urls=action_urls,
                control_url=action_urls[0] if action_urls else None,
                http_client=http_client,
            )
        except Exception:
            return None

        confirm_journal = PocJournal()
        return analyze_multi_action_results(
            probe_results,
            action_ids=confirm_ids,
            framework=self.framework_name,
            is_rsc_framework=True,
            error_categories=error_categories,
            control_results=[control_result],
            react_major=react_major,
            react_version=react_version,
            server_actions_expected=server_actions_expected,
            server_actions_confidence=server_actions_confidence,
            react_major_confidence=react_major_confidence,
            journal=confirm_journal,
        )
