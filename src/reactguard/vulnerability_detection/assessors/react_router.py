# SPDX-FileCopyrightText: 2025 Theori Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later

"""React Router assessor for CVE-2025-55182."""

from typing import Any

from ...framework_detection.keys import SIG_DETECTION_CONFIDENCE_LEVEL, SIG_INVOCATION_CONFIDENCE, TAG_REACT_ROUTER_V6, TAG_REACT_ROUTER_V7_RSC
from ...models.poc import PocStatus
from ...rsc.runner import build_request_config, run_rsc_action_probes, run_safe_args_action_probes
from ...utils import normalize_version_map
from ...utils.actions import generate_action_ids
from ..interpreters.react_router_interpreter import ReactRouterInterpreter
from ..journal import PocJournal, get_current_journal
from ..resolvers.react_router import resolve_react_router_action_context
from ..surface import surface_from_detect_context
from ..snapshots import DetectContext
from .base import BaseAssessor


class ReactRouterAssessor(BaseAssessor):
    framework_name = "react-router"

    def evaluate(
        self,
        base_url: str,
        detected_versions: dict[str, Any],
        detect_context: DetectContext | None = None,
    ) -> dict[str, Any]:
        detect_context = self._resolve_detect_context(detect_context)
        normalized_versions = normalize_version_map(detected_versions)
        journal = get_current_journal() or PocJournal()
        signals = self._context_signals(detect_context)
        tags = self._context_tags(detect_context)
        tag_set = set(tags or [])
        surface = surface_from_detect_context(detect_context)
        has_server_actions = bool(surface.invocation_surface is True)
        has_rsc_surface = bool(surface.rsc_surface is True)
        react_pick = normalized_versions.get("react_version")
        react_version = str(react_pick.value) if react_pick else None
        # CVE-2025-55182 is governed by the react-server-dom-* Flight protocol deserializer (`decodeReply`),
        # not the React core package.
        rsc_pick = normalized_versions.get("rsc_runtime_version")
        rsc_runtime_version = str(rsc_pick.value) if rsc_pick else react_version

        journal.add_event(
            "context",
            "React Router detection context",
            data={
                "signals": signals,
                "tags": tags,
                "has_server_actions_signal": has_server_actions,
                "has_rsc_surface": has_rsc_surface,
            },
        )

        if not has_server_actions:
            if TAG_REACT_ROUTER_V6 in tag_set:
                reason = "React Router v6 detected; Server Functions are v7-only"
                journal.add_decision(PocStatus.NOT_VULNERABLE, reason, rule="react_router_v6_no_server_functions")
                confidence = signals.get(SIG_DETECTION_CONFIDENCE_LEVEL) or "high"
                if confidence == "low":
                    confidence = "medium"
                return self.build_missing_surface_result(
                    reason,
                    normalized_versions,
                    surface_detected=False,
                    journal=journal,
                    confidence=confidence,
                )

            reason = "React Router detected but no Server Functions surface; Flight protocol payload deserialization not reachable"
            journal.add_decision(PocStatus.NOT_VULNERABLE, reason, rule="no_server_functions_surface")
            confidence = signals.get(SIG_INVOCATION_CONFIDENCE) or signals.get(SIG_DETECTION_CONFIDENCE_LEVEL) or "medium"
            if confidence == "low":
                confidence = "medium"
            return self.build_missing_surface_result(
                reason,
                normalized_versions,
                surface_detected=False,
                journal=journal,
                confidence=confidence,
            )

        is_rsc_framework = bool(has_server_actions)
        proto_props = ["__proto__", "constructor", "prototype"]
        action_ids = generate_action_ids(len(proto_props))
        rr_ctx = resolve_react_router_action_context(base_url, detect_context)
        wire_action_id = rr_ctx.action_id if rr_ctx else None
        action_urls = rr_ctx.urls if rr_ctx else None

        if rr_ctx and rr_ctx.synthetic_action_id:
            journal.add_event(
                "react-router-action-id",
                "No React Router Server Function ID discovered; using a synthetic ID for probing",
                data={"wire_action_id": wire_action_id},
            )

        request_config = build_request_config(
            action_id_header=None,
            base_headers={"rsc-action-id": str(wire_action_id or "")},
        )

        probe_targets = {probe_id: prop for probe_id, prop in zip(action_ids, proto_props, strict=False)}

        probe_results, control_result = run_safe_args_action_probes(
            base_url,
            action_ids,
            request_config=request_config,
            wire_action_id=str(wire_action_id or ""),
            probe_targets=probe_targets,
            action_urls=list(action_urls) if action_urls else None,
            control_url=action_urls[0] if action_urls else None,
        )

        analyzer = ReactRouterInterpreter(
            is_rsc_framework=is_rsc_framework,
            react_major=self.get_react_major(normalized_versions, detect_context),
            react_version=rsc_runtime_version,
            react_major_confidence=(
                (detect_context.react_major_confidence if detect_context else None)
                or self.get_version_confidence("react_version", normalized_versions, detect_context)
            ),
            react_major_conflict=(detect_context.react_major_conflict if detect_context else None),
            react_major_conflict_confidence=(detect_context.react_major_conflict_confidence if detect_context else None),
            react_major_conflict_majors=(detect_context.react_major_conflict_majors if detect_context else None),
            invocation_expected=True,
            invocation_confidence=signals.get(SIG_INVOCATION_CONFIDENCE),
            journal=journal,
        )
        analysis = analyzer.analyze(
            probe_results,
            action_ids=action_ids,
            control_results=[control_result],
        )

        analysis["details"]["detected_versions"] = self._version_values_for_output(normalized_versions)
        return analysis
