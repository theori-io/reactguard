"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""React Router assessor for CVE-2025-55182."""

from typing import Any

from ...framework_detection.keys import (
    SIG_DETECTION_CONFIDENCE_LEVEL,
    SIG_SERVER_ACTION_ENDPOINTS,
    SIG_SERVER_ACTIONS_CONFIDENCE,
    SIG_SERVER_ACTIONS_ENABLED,
    TAG_REACT_ROUTER_V7_RSC,
    TAG_REACT_ROUTER_V7_SERVER_ACTIONS,
)
from ...models.poc import PocStatus
from ..interpreters.multi_action import MultiActionAnalyzer
from ..journal import PocJournal, get_current_journal
from ..probes import (
    ActionProbeRunner,
    discover_next_action_ids,
    generate_action_ids,
    send_control_probe,
    send_proto_probe,
)
from .base import BaseAssessor


class ReactRouterAssessor(BaseAssessor):
    framework_name = "react-router"

    def evaluate(
        self,
        base_url: str,
        detected_versions: dict[str, Any],
        detect_context: dict | None = None,
    ) -> dict[str, Any]:
        detect_context = self._resolve_detect_context(detect_context)
        journal = get_current_journal() or PocJournal()
        signals = (detect_context or {}).get("signals", {}) or {}
        tags = (detect_context or {}).get("tags", []) or []
        has_server_actions_signal = signals.get(SIG_SERVER_ACTIONS_ENABLED)
        has_server_actions_tag = TAG_REACT_ROUTER_V7_SERVER_ACTIONS in tags
        has_server_actions = bool(has_server_actions_signal is True or has_server_actions_tag)
        has_rsc_surface = bool(TAG_REACT_ROUTER_V7_RSC in tags)

        journal.add_event(
            "context",
            "React Router detection context",
            data={
                "signals": signals,
                "tags": tags,
                "has_server_actions_signal": has_server_actions_signal,
                "has_rsc_surface": has_rsc_surface,
            },
        )

        if not has_server_actions:
            reason = "React Router detected but no server actions surface; React2Shell requires RSC / Server Actions"
            journal.add_decision(PocStatus.NOT_VULNERABLE, reason)
            return self.build_not_applicable_result(
                reason,
                detected_versions,
                surface_detected=False,
                not_affected=True,
                journal=journal,
                confidence=signals.get(SIG_SERVER_ACTIONS_CONFIDENCE) or signals.get(SIG_DETECTION_CONFIDENCE_LEVEL) or "medium",
            )

        is_rsc_framework = bool(has_server_actions)
        action_ids = generate_action_ids(3)
        control_action_id: str | None = None
        http_client = (detect_context or {}).get("http_client")
        discovered = discover_next_action_ids(base_url, http_client=http_client)
        if discovered:
            control_action_id = discovered[0]
            action_ids = [control_action_id] * len(action_ids)
        action_urls = (detect_context or {}).get(SIG_SERVER_ACTION_ENDPOINTS) if detect_context else None
        probe_runner = ActionProbeRunner(
            base_url=base_url,
            action_probe=send_proto_probe,
            control_probe=send_control_probe,
            action_urls=list(action_urls) if action_urls else None,
            control_url=action_urls[0] if action_urls else None,
        )
        probe_results, control_result = probe_runner.run(action_ids, control_action_id=control_action_id)

        analyzer = MultiActionAnalyzer(
            framework=self.framework_name,
            is_rsc_framework=is_rsc_framework,
            react_major=self.get_react_major(detected_versions, detect_context),
            react_version=detected_versions.get("react_version"),
            react_major_confidence=((detect_context or {}).get("react_major_confidence") or self.get_version_confidence("react_version", detected_versions, detect_context)),
            server_actions_expected=True,
            server_actions_confidence=signals.get(SIG_SERVER_ACTIONS_CONFIDENCE),
            journal=journal,
        )
        analysis = analyzer.analyze(
            probe_results,
            action_ids=action_ids,
            control_results=[control_result],
        )

        analysis["details"]["detected_versions"] = detected_versions
        return analysis
