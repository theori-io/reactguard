from __future__ import annotations

"""
Centralized policy for vulnerability verdict/confidence alignment.

This module intentionally focuses on *output semantics* (how we communicate uncertainty),
not transport/probing mechanics.

External contract:
- Confidence exposed to users is only: low | medium | high
- Internally some subsystems may produce "none" (meaning "no usable signal"); this normalizes to "low"
"""

from dataclasses import dataclass
from typing import Any, Literal

from ..models.poc import PocStatus

ExternalConfidence = Literal["low", "medium", "high"]
EvidenceClass = Literal["STRONG_POS", "WEAK_POS", "STRONG_NEG", "WEAK_NEG", "CONTRADICTORY", "NONE"]


def normalize_confidence(confidence: str | None) -> ExternalConfidence:
    """Normalize arbitrary confidence labels into the external low/medium/high set."""
    value = str(confidence or "").strip().lower()
    if value == "high":
        return "high"
    if value in {"med", "medium"}:
        return "medium"
    # Treat "none" (and unknown strings) as "low" externally.
    return "low"


def apply_verdict_invariants(status: PocStatus, confidence: ExternalConfidence) -> PocStatus:
    """
    Enforce minimum consistency rules between verdict and confidence.

    We require "VULNERABLE" to be backed by high confidence; otherwise downgrade to LIKELY_VULNERABLE.
    """
    if status == PocStatus.VULNERABLE and confidence != "high":
        return PocStatus.LIKELY_VULNERABLE
    return status


@dataclass(frozen=True)
class DecisionInputs:
    transport_ok: bool
    precondition_confident_false: bool
    evidence_class: EvidenceClass
    expected_surface: bool
    decode_surface_reached: bool | None
    coverage_multi: bool
    has_comparable_baseline: bool = True


def decide_verdict(inputs: DecisionInputs) -> tuple[PocStatus, ExternalConfidence]:
    """
    Apply the shared decision table for verdict+confidence.

    This is a compact encoding of plan.md's table + modifiers.
    """
    if not inputs.transport_ok:
        return (PocStatus.INCONCLUSIVE, "low")

    if inputs.precondition_confident_false:
        return (PocStatus.NOT_APPLICABLE, "high")

    if inputs.evidence_class == "CONTRADICTORY":
        confidence: ExternalConfidence = "high" if inputs.coverage_multi else "medium"
        return (PocStatus.INCONCLUSIVE, confidence)

    if inputs.evidence_class == "STRONG_POS" and inputs.decode_surface_reached is True:
        return (PocStatus.VULNERABLE, "high")

    if inputs.evidence_class == "WEAK_POS" and inputs.decode_surface_reached is True:
        confidence = "high" if inputs.coverage_multi else "medium"
        return (PocStatus.LIKELY_VULNERABLE, confidence)

    if inputs.evidence_class == "STRONG_NEG" and inputs.decode_surface_reached is True:
        return (PocStatus.NOT_VULNERABLE, "high")

    if inputs.evidence_class == "WEAK_NEG" and inputs.decode_surface_reached is True:
        return (PocStatus.LIKELY_NOT_VULNERABLE, "medium")

    # No usable directional signal.
    if inputs.expected_surface:
        confidence = "medium" if inputs.coverage_multi else "low"
        return (PocStatus.INCONCLUSIVE, confidence)

    # Missing surface / not observed surface (maps to NOT_VULNERABLE by contract).
    confidence = "medium" if inputs.coverage_multi else "low"
    return (PocStatus.NOT_VULNERABLE, confidence)


def normalize_report_mapping(report: dict[str, Any]) -> dict[str, Any]:
    """
    Normalize a mapping-style report (status/details/raw_data) to match external contract.

    This function:
    - normalizes details.confidence into low/medium/high
    - enforces basic verdict invariants (currently: VULNERABLE requires high)
    """
    if not isinstance(report, dict):
        return report
    status = report.get("status")
    details = report.get("details")
    if isinstance(details, dict):
        details_conf = normalize_confidence(details.get("confidence"))
        details["confidence"] = details_conf
        if isinstance(status, PocStatus):
            report["status"] = apply_verdict_invariants(status, details_conf)
    return report


__all__ = [
    "DecisionInputs",
    "EvidenceClass",
    "ExternalConfidence",
    "apply_verdict_invariants",
    "decide_verdict",
    "normalize_confidence",
    "normalize_report_mapping",
]

