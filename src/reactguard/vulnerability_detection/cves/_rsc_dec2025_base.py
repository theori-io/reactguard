from __future__ import annotations

"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Shared base for Dec 2025 React Server Components CVE detectors."""

from ...framework_detection.engine import FrameworkDetectionEngine
from ...framework_detection.keys import (
    SIG_DETECTION_CONFIDENCE,
    SIG_DETECTION_CONFIDENCE_LEVEL,
    SIG_FETCH_ERROR_MESSAGE,
    TAG_EXPO,
    TAG_NEXTJS,
    TAG_NEXTJS_APP_ROUTER,
    TAG_REACT_ROUTER_V6,
    TAG_REACT_ROUTER_V7,
    TAG_REACT_STREAMING,
    TAG_RSC,
    TAG_WAKU,
)
from ...models import FrameworkDetectionResult, ScanRequest, VulnerabilityReport
from ...models.poc import PocStatus
from ...utils.context import get_scan_context, scan_context
from ..assessors import ReactServerComponentsDec2025Assessor, RscDec2025Spec
from ..plugin import PocPlugin
from ..snapshots import DetectionSnapshot
from ..surface import build_missing_surface_report, compute_rsc_server_functions_surface
from ._rsc_common import (
    RSC_SERVER_FUNCTIONS_SURFACE_CACHE_KEY,
    build_fetch_failure_report,
    run_assessor_with_context,
)

RSC_DEC2025_APPLICABLE_TAGS = [
    TAG_NEXTJS,
    TAG_NEXTJS_APP_ROUTER,
    TAG_WAKU,
    TAG_EXPO,
    TAG_REACT_ROUTER_V7,
    TAG_REACT_ROUTER_V6,
    TAG_RSC,
]


class RscDec2025CveDetector(PocPlugin):
    """Shared detector runner for Dec 2025 React Server Components CVEs."""

    applicable_tags = RSC_DEC2025_APPLICABLE_TAGS

    def __init__(
        self,
        spec: RscDec2025Spec,
        detection_engine: FrameworkDetectionEngine | None = None,
    ):
        self.spec = spec
        self.name = spec.cve_id.lower()
        self.detection_engine = detection_engine or FrameworkDetectionEngine()
        self.assessor = ReactServerComponentsDec2025Assessor(spec)

    def evaluate(
        self,
        url: str,
        *,
        detection_result: FrameworkDetectionResult | None = None,
        proxy_profile: str | None = None,
        correlation_id: str | None = None,
    ) -> VulnerabilityReport:
        context = get_scan_context()
        if context.http_client is None:
            with scan_context(
                http_client=getattr(self.detection_engine, "http_client", None),
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
            ):
                return self._evaluate_ctx(url, detection_result=detection_result, proxy_profile=proxy_profile, correlation_id=correlation_id)
        return self._evaluate_ctx(url, detection_result=detection_result, proxy_profile=proxy_profile, correlation_id=correlation_id)

    def _evaluate_ctx(
        self,
        url: str,
        *,
        detection_result: FrameworkDetectionResult | None,
        proxy_profile: str | None,
        correlation_id: str | None,
    ) -> VulnerabilityReport:
        cve_id = self.spec.cve_id
        context = get_scan_context()

        detection = detection_result or self.detection_engine.detect(ScanRequest(url=url, proxy_profile=proxy_profile, correlation_id=correlation_id))
        snapshot = DetectionSnapshot.from_detection(detection)
        surface = compute_rsc_server_functions_surface(snapshot)
        has_streaming_hint = TAG_REACT_STREAMING in set(snapshot.tags or [])

        if snapshot.signals.get(SIG_FETCH_ERROR_MESSAGE):
            return build_fetch_failure_report(
                cve_id=cve_id,
                detection=detection,
            )

        if isinstance(context.extra, dict) and context.extra.get(RSC_SERVER_FUNCTIONS_SURFACE_CACHE_KEY) is True:
            return build_missing_surface_report(
                cve_id=cve_id,
                snapshot=snapshot,
                surface=surface,
                status=PocStatus.NOT_VULNERABLE,
                reason="No RSC Server Functions decode surface detected",
            )

        if surface.server_functions_surface is False and not has_streaming_hint:
            return build_missing_surface_report(
                cve_id=cve_id,
                snapshot=snapshot,
                surface=surface,
                status=PocStatus.NOT_VULNERABLE,
                reason="No RSC Server Functions decode surface detected",
            )

        result = run_assessor_with_context(
            self.assessor,
            url=url,
            snapshot=snapshot,
        )

        result["details"]["detection_confidence"] = snapshot.signals.get(SIG_DETECTION_CONFIDENCE)
        result["details"]["detection_confidence_level"] = snapshot.signals.get(SIG_DETECTION_CONFIDENCE_LEVEL)
        result["details"]["detection_tags"] = snapshot.tags
        result["details"]["attack_surface"] = surface.to_dict()
        return VulnerabilityReport.from_mapping(result)


__all__ = ["RSC_DEC2025_APPLICABLE_TAGS", "RscDec2025CveDetector"]
