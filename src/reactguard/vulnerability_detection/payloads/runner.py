from __future__ import annotations

"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""Shared orchestration helpers for running multi-action probes."""

from collections.abc import Callable, Iterable
from typing import Any

ProbeFunc = Callable[..., dict[str, Any]]


def run_action_probes(
    base_url: str,
    action_ids: Iterable[str],
    *,
    action_probe: ProbeFunc,
    control_probe: ProbeFunc,
    proxy_profile: str | None = None,
    correlation_id: str | None = None,
    control_action_id: str = "control_probe",
    probe_kwargs: dict[str, Any] | None = None,
    control_kwargs: dict[str, Any] | None = None,
    action_urls: Iterable[str] | None = None,
    control_url: str | None = None,
    http_client: Any = None,
) -> tuple[list[dict[str, Any]], dict[str, Any], set[str]]:
    """
    Execute a series of action probes plus one control probe.

    Returns (probe_results, control_result, error_categories).
    """
    results: list[dict[str, Any]] = []
    error_categories: set[str] = set()
    extra_probe_kwargs = dict(probe_kwargs or {})
    extra_control_kwargs = dict(control_kwargs or {})
    if http_client is not None:
        extra_probe_kwargs.setdefault("http_client", http_client)
        extra_control_kwargs.setdefault("http_client", http_client)
    action_targets = list(action_urls or [])

    for index, action_id in enumerate(action_ids):
        target_url = action_targets[index] if index < len(action_targets) else base_url
        try:
            result = action_probe(
                target_url,
                action_id=action_id,
                proxy_profile=proxy_profile,
                correlation_id=correlation_id,
                **extra_probe_kwargs,
            )
        except Exception as exc:  # noqa: BLE001
            result = {"ok": False, "error": str(exc)}

        if result.get("action_id") is None:
            result["action_id"] = action_id
        if not result.get("ok") and result.get("error_category"):
            error_categories.add(result.get("error_category"))
        results.append(result)

    control_target = control_url or (action_targets[0] if action_targets else base_url)

    try:
        control_result = control_probe(
            control_target,
            action_id=control_action_id,
            proxy_profile=proxy_profile,
            correlation_id=correlation_id,
            **extra_control_kwargs,
        )
    except Exception as exc:  # noqa: BLE001
        control_result = {"ok": False, "error": str(exc)}

    if control_result.get("action_id") is None:
        control_result["action_id"] = control_action_id

    return results, control_result, error_categories


__all__ = ["run_action_probes"]
