"""
ReactGuard, framework- and vulnerability-detection tooling for CVE-2025-55182 (React2Shell).
Copyright (C) 2025  Theori Inc.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
"""

"""JSON-based server action probe for CVE-2025-55182."""

import secrets
from typing import Any

from ...config import load_http_settings
from ...utils.context import scan_context
from ..http import scan_with_retry


def _user_agent() -> str:
    return load_http_settings().user_agent


def _send_json_probe_ctx(
    url: str,
    payload: str,
    *,
    action_id: str,
) -> dict[str, Any]:
    headers = {
        "Content-Type": "application/json",
        "Next-Action": action_id,
        "Accept": "application/json, text/x-component",
        "User-Agent": _user_agent(),
    }

    scan = scan_with_retry(
        url,
        method="POST",
        headers=headers,
        body=payload,
    )

    if not scan.get("ok"):
        return {
            "error": scan.get("error_message"),
            "error_category": scan.get("error_category"),
            "error_type": scan.get("error_type"),
        }

    return scan


def _send_json_probe(
    url: str,
    payload: str,
    *,
    action_id: str,
    proxy_profile: str | None = None,
    correlation_id: str | None = None,
    http_client=None,
) -> dict[str, Any]:
    if proxy_profile is not None or correlation_id is not None or http_client is not None:
        with scan_context(proxy_profile=proxy_profile, correlation_id=correlation_id, http_client=http_client):
            return _send_json_probe_ctx(url, payload, action_id=action_id)
    return _send_json_probe_ctx(url, payload, action_id=action_id)


def send_json_action_probe(
    url: str,
    action_id: str = "proto_probe",
    proxy_profile: str | None = None,
    correlation_id: str | None = None,
    http_client=None,
) -> dict[str, Any]:
    payload = '[{"x":{}}, "$F0:x:__proto__"]'
    return _send_json_probe(
        url,
        payload,
        action_id=action_id,
        proxy_profile=proxy_profile,
        correlation_id=correlation_id,
        http_client=http_client,
    )


def send_json_control_probe(
    url: str,
    action_id: str = "control_probe",
    proxy_profile: str | None = None,
    correlation_id: str | None = None,
    http_client=None,
) -> dict[str, Any]:
    random_safe_path = f"z{secrets.token_hex(4)}"
    payload = f'[{{"x":{{}}}}, "$F0:x:{random_safe_path}"]'
    return _send_json_probe(
        url,
        payload,
        action_id=action_id,
        proxy_profile=proxy_profile,
        correlation_id=correlation_id,
        http_client=http_client,
    )
