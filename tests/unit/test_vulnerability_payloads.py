from reactguard.vulnerability_detection.probes import (
    check_server_actions,
    run_action_probes,
    send_control_probe,
    send_json_action_probe,
    send_json_control_probe,
    send_proto_probe,
    send_waku_probe,
)


def test_run_action_probes_handles_errors_and_injects_ids():
    def failing_probe(url, action_id, **kwargs):  # noqa: ARG001
        return {"ok": False, "error_category": "TIMEOUT"}

    def control_probe(url, action_id, **kwargs):  # noqa: ARG001
        return {"ok": True}

    results, control = run_action_probes(
        "http://example",
        ["a1", "a2"],
        action_probe=failing_probe,
        control_probe=control_probe,
        http_client="client",
    )
    assert len(results) == 2
    assert results[0]["action_id"] == "a1"
    assert control["action_id"] == "control_probe"
    assert results[0]["error_category"] == "TIMEOUT"


def test_run_action_probes_does_not_allow_action_id_override():
    seen: list[str] = []

    def probe(url, action_id, **kwargs):  # noqa: ARG001
        seen.append(action_id)
        return {"ok": True}

    def control_probe(url, action_id, **kwargs):  # noqa: ARG001
        seen.append(action_id)
        return {"ok": True}

    run_action_probes(
        "http://example",
        ["a1"],
        action_probe=probe,
        control_probe=control_probe,
        probe_kwargs={"action_id": "evil"},
        control_kwargs={"action_id": "evil"},
    )

    assert seen == ["a1", "control_probe"]


def test_proto_and_control_probes_return_errors(monkeypatch):
    monkeypatch.setattr(
        "reactguard.vulnerability_detection.probes.proto_probe.request_with_retries",
        lambda *_, **__: {"ok": False, "error_message": "fail", "error_category": "TIMEOUT", "error_type": "Timeout"},
    )
    proto = send_proto_probe("http://example", action_id="x")
    assert proto["error_category"] == "TIMEOUT"
    ctrl = send_control_probe("http://example", action_id="y")
    assert ctrl["error_type"] == "Timeout"


def test_check_server_actions_wraps_probe(monkeypatch):
    monkeypatch.setattr(
        "reactguard.vulnerability_detection.probes.proto_probe.probe_server_actions_support",
        lambda *_, **__: {"supported": True, "status_code": 200, "has_action_keywords": True, "has_flight_marker": False, "content_type": "text/plain"},
    )
    result = check_server_actions("http://example", action_id="z")
    assert result["supported"] is True
    assert result["status_code"] == 200


def test_json_action_probes(monkeypatch):
    monkeypatch.setattr(
        "reactguard.vulnerability_detection.probes.json_action_probe.request_with_retries",
        lambda *_, **__: {"ok": True, "status_code": 200, "body": "{}", "headers": {}},
    )
    res = send_json_action_probe("http://example")
    assert res["status_code"] == 200
    ctrl = send_json_control_probe("http://example", action_id="a1")
    assert ctrl["ok"] is True


def test_waku_probe_error_path(monkeypatch):
    monkeypatch.setattr(
        "reactguard.vulnerability_detection.probes.waku_probe.request_with_retries",
        lambda *_, **__: {"ok": False, "error_message": "boom", "error_category": "SSL_ERROR", "error_type": "SSLError"},
    )
    res = send_waku_probe("http://example/RSC/F/abc/action.txt")
    assert res["error_category"] == "SSL_ERROR"
