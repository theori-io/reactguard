# SPDX-FileCopyrightText: 2025 Theori Inc.
# SPDX-License-Identifier: AGPL-3.0-or-later

from reactguard.models.poc import PocStatus
from reactguard.rsc.types import RscResponse
from reactguard.vulnerability_detection.interpreters import multi_action, waku_interpreter
from reactguard.vulnerability_detection.interpreters.rsc_dec2025_interpreter import RscDec2025Interpreter
from reactguard.vulnerability_detection.journal import PocJournal


def rsc_response(**data) -> RscResponse:
    body = data.pop("body", data.pop("body_snippet", ""))
    text = str(body or "")
    ok = data.pop("ok", data.get("status_code") is not None)
    return RscResponse(
        ok=ok,
        status_code=data.get("status_code"),
        headers=data.get("headers") or {},
        text=text,
        content=text.encode(),
        url=data.get("url"),
        error_message=data.get("error_message"),
        error_type=data.get("error_type"),
        endpoint=data.get("endpoint", ""),
        action_id=data.get("action_id"),
        request_wire_format=data.get("request_wire_format", ""),
        payload_meta=data.get("payload_meta") or {},
    )


def responses(items: list[dict]) -> list[RscResponse]:
    return [rsc_response(**item) for item in items]


def test_multi_action_all_fail_inconclusive():
    result = multi_action.analyze_multi_action_results(
        responses([{"ok": False, "error_message": "TIMEOUT", "error_type": "Timeout"}]),
        control_results=[],
        is_rsc_framework=False,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["framework"] == "nextjs"


def test_multi_action_not_vulnerable_when_no_actions():
    probes = responses(
        [{"status_code": 404, "body": "action not found", "headers": {}, "body_snippet": "action not found"} for _ in range(2)]
    )
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="react-router",
        is_rsc_framework=False,
        invocation_expected=False,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["surface_detected"] is False


def test_multi_action_success_path_not_vulnerable():
    probes = responses([{"status_code": 200, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["}])
    control = responses([{"status_code": 200, "body": "ok", "headers": {}, "body_snippet": "ok"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        control_results=control,
    )
    assert result["status"] == PocStatus.NOT_VULNERABLE
    assert result["details"]["confidence"] in {"high", "medium"}


def test_multi_action_prototype_errors_vulnerable():
    probes = responses([
        {"status_code": 500, "body": "Prototype chain failed", "headers": {"content-type": "text/x-component"}, "body_snippet": "Prototype chain failed"},
        {"status_code": 500, "body": "Prototype crashed", "headers": {"content-type": "text/x-component"}, "body_snippet": "Prototype crashed"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_validation_errors_not_applicable():
    probes = responses([{"status_code": 400, "body": "action not found", "headers": {}, "body_snippet": "action not found"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] in {PocStatus.NOT_APPLICABLE, PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_rsc_processing_inconclusive():
    probes = responses([
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_html_responses_branch():
    probes = responses([{"status_code": 200, "body": "<html>ok</html>", "headers": {"content-type": "text/html"}, "body_snippet": "<html>ok</html>"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        invocation_expected=False,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_multiple_digests_vulnerable():
    probes = responses([
        {"status_code": 500, "body": '{"digest":"abc123"}', "headers": {}, "body_snippet": '{"digest":"abc123"}'},
        {"status_code": 500, "body": '{"digest":"def456"}', "headers": {}, "body_snippet": '{"digest":"def456"}'},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_digest_divergence_with_control():
    probes = responses(
        [{"status_code": 500, "body": '{"digest":"xyz789"}', "headers": {}, "body_snippet": '{"digest":"xyz789"}'} for _ in range(2)]
    )
    control = responses([{"status_code": 200, "body": '{"digest":"other1"}', "headers": {}, "body_snippet": '{"digest":"other1"}'}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
        control_results=control,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_dev_overlay_handling():
    probes = responses([{"status_code": 500, "body": "<html>__next_error__</html>", "headers": {}, "body_snippet": "<html>__next_error__</html>"}])
    control = responses([{"status_code": 500, "body": "<html>__next_error__</html>", "headers": {}, "body_snippet": "<html>__next_error__</html>"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=True,
        control_results=control,
        react_major=19,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_success_precedes_dev_overlay():
    probes = responses([
        {"status_code": 200, "body": "0:{}", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:{}"},
        {"status_code": 500, "body": "<html>__next_error__</html>", "headers": {"content-type": "text/html"}, "body_snippet": "<html>__next_error__</html>"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE


def test_multi_action_proxy_error_short_circuit():
    probes = responses([
        {"status_code": 502, "body": "proxy error: upstream", "headers": {}, "body_snippet": "proxy error"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["confidence"] == "low"
    assert result["details"]["surface_detected"] is False


def test_multi_action_proxy_errors_override_other_signals():
    probes = responses([
        {"status_code": 502, "body": 'proxy error {"digest":"abcdef123456"}', "headers": {}, "body_snippet": 'proxy error {"digest":"abcdef123456"}'},
        {"status_code": 502, "body": "proxy error upstream", "headers": {}, "body_snippet": "proxy error upstream"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["confidence"] == "low"


def test_multi_action_rsc_no_actions_identical_digests():
    probes = responses([
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {"content-type": "text/x-component"}, "body_snippet": '{"digest":"abcdef123456"}'},
    ])
    control = responses([
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {"content-type": "text/x-component"}, "body_snippet": '{"digest":"abcdef123456"}'},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=False,
        control_results=control,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["surface_detected"] is True


def test_multi_action_server_actions_error_with_validation():
    probes = responses([
        {"status_code": 500, "body": "action not found", "headers": {}, "body_snippet": "action not found"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE


def test_multi_action_multiple_digests_non_rsc_no_actions():
    probes = responses([
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {}, "body_snippet": '{"digest":"abcdef123456"}'},
        {"status_code": 500, "body": '{"digest":"fedcba654321"}', "headers": {}, "body_snippet": '{"digest":"fedcba654321"}'},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE
    assert result["details"]["surface_detected"] is False


def test_multi_action_validation_errors_surface_off():
    probes = responses([{"status_code": 400, "body": "action not found", "headers": {}, "body_snippet": "action not found"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] in {PocStatus.NOT_APPLICABLE, PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}
    assert result["details"]["surface_detected"] is False


def test_multi_action_structural_divergence_locale_agnostic():
    probes = responses([
        {"status_code": 500, "body": '0:{"name":"TypeError","message":"No se puede leer propiedades"}', "headers": {"content-type": "application/json"}, "body_snippet": ""},
        {"status_code": 500, "body": '0:{"name":"TypeError","message":"Lectura fallida"}', "headers": {"content-type": "application/json"}, "body_snippet": ""},
    ])
    control = responses([{"status_code": 500, "body": '0:{"error":{"code":400,"message":"Accion desconocida"}}', "headers": {"content-type": "application/json"}, "body_snippet": ""}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
        control_results=control,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}
    assert "structurally" in result["details"]["reason"].lower()
    assert result["details"]["surface_detected"] is True


def test_multi_action_error_messages_path():
    probes = responses([
        {"status_code": 500, "body": "plain error one", "headers": {}, "body_snippet": "plain error one"},
        {"status_code": 500, "body": "plain error two", "headers": {}, "body_snippet": "plain error two"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        invocation_expected=True,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE}


def test_multi_action_single_probe_short_circuit():
    probes = responses([{"status_code": 502, "body": "gateway", "headers": {}, "body_snippet": "gateway"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_single_probe_with_prototype_errors_still_inconclusive():
    probes = responses([{"status_code": 500, "body": "prototype crash", "headers": {"content-type": "text/x-component"}, "body_snippet": "prototype crash"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=None,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_rsc_digest_without_actions():
    probes = responses([{"status_code": 500, "body": '{"digest":"abc123"}', "headers": {}, "body_snippet": '{"digest":"abc123"}'}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="rsc",
        is_rsc_framework=True,
        invocation_expected=False,
    )
    assert result["status"] in {
        PocStatus.INCONCLUSIVE,
        PocStatus.LIKELY_VULNERABLE,
        PocStatus.LIKELY_NOT_VULNERABLE,
        PocStatus.VULNERABLE,
        PocStatus.NOT_VULNERABLE,
    }


def test_multi_action_rsc_processing_only_surface_detected():
    probes = responses([
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["surface_detected"] is True


def test_multi_action_react_version_confidence_blocks_vuln():
    probes = responses([
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {"content-type": "text/x-component"}, "body_snippet": '{"digest":"abcdef123456"}'},
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {"content-type": "text/x-component"}, "body_snippet": '{"digest":"abcdef123456"}'},
    ])
    control = responses([
        {"status_code": 500, "body": '{"digest":"abcdef123456"}', "headers": {"content-type": "text/x-component"}, "body_snippet": '{"digest":"abcdef123456"}'},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
        control_results=control,
        react_major=18,
        react_major_confidence="high",
    )
    assert result["status"] == PocStatus.NOT_APPLICABLE
    assert result["details"]["surface_detected"] is True


def test_multi_action_validation_errors_on_rsc():
    probes = responses([{"status_code": 400, "body": "action not found", "headers": {}, "body_snippet": "action not found"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE
    assert result["details"]["decode_surface_reached"] is False


def test_multi_action_html_rsc_surface():
    probes = responses([{"status_code": 200, "body": "<html>ok</html>", "headers": {"content-type": "text/html"}, "body_snippet": "<html>ok</html>"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=False,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE


def test_multi_action_single_digest_with_control_divergence():
    probes = responses(
        [{"status_code": 500, "body": '{"digest":"abc123"}', "headers": {}, "body_snippet": '{"digest":"abc123"}'} for _ in range(2)]
    )
    control = responses([{"status_code": 500, "body": '{"digest":"def456"}', "headers": {}, "body_snippet": '{"digest":"def456"}'}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
        control_results=control,
        react_major=19,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_server_actions_errors_expected():
    probes = responses([{"status_code": 500, "body": "action not found", "headers": {}, "body_snippet": "action not found"}])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        invocation_expected=True,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_prototype_errors_without_actions():
    probes = responses([
        {"status_code": 400, "body": "prototype chain", "headers": {}, "body_snippet": "prototype chain"},
        {"status_code": 400, "body": "prototype crash", "headers": {}, "body_snippet": "prototype crash"},
    ])
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        invocation_expected=None,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.VULNERABLE}


def test_analyze_waku_results_no_surface_and_empty_responses():
    result = waku_interpreter.analyze_waku_results([], endpoints=[])
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE

    empty_result = waku_interpreter.analyze_waku_results(
        responses([{"status_code": 500, "body": "", "body_snippet": "", "headers": {}, "endpoint": "/RSC/F/abc/action.txt"}]),
        endpoints=[("/RSC/F/abc/action.txt", "action")],
        react_major=18,
        react_major_confidence="high",
    )
    assert empty_result["status"] == PocStatus.NOT_APPLICABLE


def test_analyze_waku_results_empty_500_valid_endpoint_is_likely_vulnerable_for_react19():
    probe_results = responses([
        {
            "status_code": 500,
            "body": "",
            "body_snippet": "",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
        }
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abcdef12345678/t.txt", "t")],
        react_major=19,
        react_major_confidence="high",
    )
    assert result["status"] == PocStatus.LIKELY_VULNERABLE


def test_analyze_waku_results_detects_patch_and_vuln():
    patched_probe = responses([
        {
            "status_code": 200,
            "body": "$T1: reference",
            "body_snippet": "$T1: reference",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        }
    ])
    patched = waku_interpreter.analyze_waku_results(patched_probe, endpoints=[("/RSC/F/abc/t.txt", "t")])
    assert patched["status"] == PocStatus.NOT_VULNERABLE

    vuln_probe = responses([
        {
            "status_code": 200,
            "body": "0:{}",
            "body_snippet": "0:{}",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/u.txt",
        }
    ])
    vulnerable = waku_interpreter.analyze_waku_results(vuln_probe, endpoints=[("/RSC/F/abc/u.txt", "u")])
    assert vulnerable["status"] == PocStatus.LIKELY_VULNERABLE


def test_analyze_waku_results_control_comparison():
    probe_results = responses([
        {
            "status_code": 500,
            "body": "formData.get is not a function",
            "body_snippet": "formData.get is not a function",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        },
    ])
    control_results = responses([
        {
            "status_code": 500,
            "body": "formData.get is not a function",
            "body_snippet": "formData.get is not a function",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        },
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE}


def test_analyze_waku_results_no_invoke_strategy_match_is_likely_not_vulnerable():
    probe_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"deadbeef"}',
            "body_snippet": '1:E{"digest":"deadbeef"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "no_invoke_root_ref_string"},
        },
    ])
    control_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"deadbeef"}',
            "body_snippet": '1:E{"digest":"deadbeef"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "no_invoke_root_ref_string"},
        },
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abcdef12345678/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE}


def test_analyze_waku_results_safe_args_match_is_vulnerable():
    probe_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"deadbeef"}',
            "body_snippet": '1:E{"digest":"deadbeef"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "safe_args_bigint_length"},
        },
    ])
    control_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"deadbeef"}',
            "body_snippet": '1:E{"digest":"deadbeef"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "safe_args_bigint_length"},
        },
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abcdef12345678/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] == PocStatus.LIKELY_VULNERABLE


def test_analyze_waku_results_safe_args_divergence_is_likely_not_vulnerable():
    probe_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"proto123"}',
            "body_snippet": '1:E{"digest":"proto123"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "safe_args_bigint_length"},
        },
    ])
    control_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"ctrl123"}',
            "body_snippet": '1:E{"digest":"ctrl123"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "safe_args_bigint_length"},
        },
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abcdef12345678/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE


def test_analyze_waku_results_no_invoke_strategy_divergence_is_vulnerable():
    probe_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"proto123"}',
            "body_snippet": '1:E{"digest":"proto123"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "no_invoke_root_ref_string"},
        },
    ])
    control_results = responses([
        {
            "status_code": 500,
            "body": '1:E{"digest":"ctrl123"}',
            "body_snippet": '1:E{"digest":"ctrl123"}',
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abcdef12345678/t.txt",
            "payload_meta": {"probe_strategy": "no_invoke_root_ref_string"},
        },
    ])
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abcdef12345678/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_analyze_waku_results_all_failed_returns_inconclusive():
    probe_results = responses(
        [{"ok": False, "status_code": None, "error_message": "boom", "error_type": "Timeout", "headers": {}, "body_snippet": ""}]
    )
    control_results = responses(
        [{"ok": False, "status_code": None, "error_message": "boom", "error_type": "Timeout", "headers": {}, "body_snippet": ""}]
    )
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/u.txt", "u")],
        control_results=control_results,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert "network" in result["details"]["reason"].lower()
    assert result["details"]["decision_rule"] == "all_probes_failed"
    assert result["raw_data"]["probe_results"] == [res.to_mapping() for res in probe_results]
    assert result["raw_data"]["control_results"] == [res.to_mapping() for res in control_results]

    decision_entries = [e for e in result["raw_data"]["journal"] if e.get("step") == "decision"]
    assert decision_entries
    assert decision_entries[-1]["data"]["decision_rule"] == "all_probes_failed"


def test_analyze_waku_results_success_without_t():
    probe_results = responses(
        [{"status_code": 200, "body": "0:{}", "body_snippet": "0:{}", "headers": {"content-type": "text/x-component"}, "endpoint": "/RSC/F/abc/u.txt"}]
    )
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/u.txt", "u")],
        react_major=19,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_analyze_waku_results_structural_patterns():
    probe_results = responses(
        [
            {
                "status_code": 500,
                "body": '{"name":"TypeError","message":"No se puede leer propiedad"}',
                "body_snippet": '{"name":"TypeError","message":"No se puede leer propiedad"}',
                "headers": {"content-type": "text/x-component"},
                "endpoint": "/RSC/F/abc/u.txt",
            }
        ]
    )
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/u.txt", "u")],
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_poc_journal_trims_and_serializes():
    journal = PocJournal(entry_limit_bytes=64, max_entries=2)
    journal.add_event("step", "summary", data={"key": "value"})
    journal.add_event("probe", "long" * 50, data="x" * 200)
    journal.add_decision("status", "done")
    entries = journal.to_list()
    assert len(entries) == 2 or entries[-1]["step"] == "journal-truncated"
    assert entries[0]["step"] == "step"


def test_poc_journal_add_probe_content_type_is_case_insensitive():
    journal = PocJournal()
    journal.add_probe(
        "proto",
        status_code=200,
        body_snippet="ok",
        headers={"Content-Type": "text/x-component"},
    )
    entries = journal.to_list()
    probe_entries = [e for e in entries if e.get("step") == "probe"]
    assert probe_entries
    assert probe_entries[0]["data"]["content_type"] == "text/x-component"


def test_dec2025_interpreter_not_applicable_when_flight_is_react18():
    interpreter = RscDec2025Interpreter(cve_id="CVE-2025-55184", framework="nextjs")
    journal = PocJournal()
    result = interpreter.to_report(
        patch_fingerprint="pre_35345",
        detected_versions={},
        evidence={
            "react_major_from_flight": 18,
            "react_major_from_flight_confidence": "high",
        },
        journal=journal,
        invocation_enabled=None,
        invocation_confidence=None,
    )
    assert result["status"] == PocStatus.NOT_APPLICABLE
    assert "react 18" in str(result["details"]["reason"]).lower()


def test_dec2025_interpreter_pre_35345_when_flight_is_react19():
    interpreter = RscDec2025Interpreter(cve_id="CVE-2025-55184", framework="nextjs")
    journal = PocJournal()
    result = interpreter.to_report(
        patch_fingerprint="pre_35345",
        detected_versions={},
        evidence={
            "react_major_from_flight": 19,
            "react_major_from_flight_confidence": "high",
            "pr35345_evidence_strength": "strong",
            "pr35345_marker_stable": True,
        },
        journal=journal,
        invocation_enabled=None,
        invocation_confidence=None,
    )
    assert result["status"] == PocStatus.VULNERABLE


def test_dec2025_interpreter_cve_55183_not_vulnerable_when_surface_closed():
    interpreter = RscDec2025Interpreter(cve_id="CVE-2025-55183", framework="nextjs")
    journal = PocJournal()
    result = interpreter.to_report(
        patch_fingerprint="pre_35345",
        detected_versions={},
        evidence={
            "pr35345_marker_method": "marker_diff_h_is_conn_f_not",
            "pr35345_marker_stable": True,
            "pr35345_evidence_strength": "strong",
        },
        journal=journal,
        invocation_enabled=False,
        invocation_confidence="high",
    )
    assert result["status"] == PocStatus.NOT_VULNERABLE
    assert result["details"]["decision_rule"] == "cve_55183_surface_closed"


def test_dec2025_interpreter_keeps_inconclusive_when_fingerprint_missing_with_inconclusive_probes():
    interpreter = RscDec2025Interpreter(cve_id="CVE-2025-55184", framework="react-router")
    journal = PocJournal()
    result = interpreter.to_report(
        patch_fingerprint=None,
        detected_versions={},
        evidence={"reason": "Marker probes were inconclusive on all candidate endpoints"},
        journal=journal,
        invocation_enabled=None,
        invocation_confidence=None,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
