from reactguard.models.poc import PocStatus
from reactguard.vulnerability_detection.interpreters import digest, multi_action, waku_interpreter
from reactguard.vulnerability_detection.journal import PocJournal


def test_digest_extractors():
    body = '{"digest":"abc123"} {"digest":"def456"}'
    assert digest.extract_digests(body) == {"abc123", "def456"}
    results = [{"body": body}, {"body_snippet": '{"digest":"789abc"}'}]
    assert digest.extract_digests_from_results(results) == {"abc123", "def456", "789abc"}


def test_multi_action_all_fail_inconclusive():
    result = multi_action.analyze_multi_action_results(
        [{"ok": False, "error_category": "TIMEOUT"}],
        error_categories={"TIMEOUT"},
        control_results=[],
        is_rsc_framework=False,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE
    assert result["details"]["framework"] == "nextjs"


def test_multi_action_not_vulnerable_when_no_actions():
    probes = [{"status_code": 404, "body": "action not found", "headers": {}, "body_snippet": "action not found"} for _ in range(2)]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="react-router",
        is_rsc_framework=False,
        server_actions_expected=False,
    )
    assert result["status"] == PocStatus.NOT_VULNERABLE
    assert result["details"]["surface_detected"] is False


def test_multi_action_success_path_not_vulnerable():
    probes = [{"status_code": 200, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["}]
    control = [{"status_code": 200, "body": "ok", "headers": {}, "body_snippet": "ok"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        control_results=control,
    )
    assert result["status"] == PocStatus.NOT_VULNERABLE
    assert result["details"]["confidence"] in {"high", "medium"}


def test_multi_action_prototype_errors_vulnerable():
    probes = [
        {"status_code": 500, "body": "Prototype chain failed", "headers": {"content-type": "text/x-component"}, "body_snippet": "Prototype chain failed"},
        {"status_code": 500, "body": "Prototype crashed", "headers": {"content-type": "text/x-component"}, "body_snippet": "Prototype crashed"},
    ]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_validation_errors_not_applicable():
    probes = [{"status_code": 400, "body": "action not found", "headers": {}, "body_snippet": "action not found"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        server_actions_expected=None,
    )
    assert result["status"] in {PocStatus.NOT_APPLICABLE, PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_rsc_processing_inconclusive():
    probes = [
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
        {"status_code": 418, "body": "0:[", "headers": {"content-type": "text/x-component"}, "body_snippet": "0:["},
    ]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        server_actions_expected=None,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_html_responses_branch():
    probes = [{"status_code": 200, "body": "<html>ok</html>", "headers": {"content-type": "text/html"}, "body_snippet": "<html>ok</html>"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        server_actions_expected=False,
    )
    assert result["status"] in {PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_multiple_digests_vulnerable():
    probes = [
        {"status_code": 500, "body": '{"digest":"abc"}', "headers": {}, "body_snippet": '{"digest":"abc"}'},
        {"status_code": 500, "body": '{"digest":"def"}', "headers": {}, "body_snippet": '{"digest":"def"}'},
    ]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_digest_divergence_with_control():
    probes = [{"status_code": 500, "body": '{"digest":"xyz"}', "headers": {}, "body_snippet": '{"digest":"xyz"}'} for _ in range(2)]
    control = [{"status_code": 200, "body": '{"digest":"other"}', "headers": {}, "body_snippet": '{"digest":"other"}'}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
        control_results=control,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_dev_overlay_handling():
    probes = [{"status_code": 500, "body": "<html>__next_error__</html>", "headers": {}, "body_snippet": "<html>__next_error__</html>"}]
    control = [{"status_code": 500, "body": "<html>__next_error__</html>", "headers": {}, "body_snippet": "<html>__next_error__</html>"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        server_actions_expected=True,
        control_results=control,
        react_major=19,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_error_messages_path():
    probes = [
        {"status_code": 500, "body": "plain error one", "headers": {}, "body_snippet": "plain error one"},
        {"status_code": 500, "body": "plain error two", "headers": {}, "body_snippet": "plain error two"},
    ]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="spa",
        is_rsc_framework=False,
        server_actions_expected=True,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE}


def test_multi_action_single_probe_short_circuit():
    probes = [{"status_code": 502, "body": "gateway", "headers": {}, "body_snippet": "gateway"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        server_actions_expected=True,
    )
    assert result["status"] == PocStatus.INCONCLUSIVE


def test_multi_action_rsc_digest_without_actions():
    probes = [{"status_code": 500, "body": '{"digest":"abc"}', "headers": {}, "body_snippet": '{"digest":"abc"}'}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="rsc",
        is_rsc_framework=True,
        server_actions_expected=False,
    )
    assert result["status"] in {
        PocStatus.LIKELY_VULNERABLE,
        PocStatus.LIKELY_NOT_VULNERABLE,
        PocStatus.VULNERABLE,
        PocStatus.NOT_VULNERABLE,
    }


def test_multi_action_validation_errors_on_rsc():
    probes = [{"status_code": 400, "body": "action not found", "headers": {}, "body_snippet": "action not found"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE, PocStatus.NOT_APPLICABLE}


def test_multi_action_html_rsc_surface():
    probes = [{"status_code": 200, "body": "<html>ok</html>", "headers": {"content-type": "text/html"}, "body_snippet": "<html>ok</html>"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=False,
    )
    assert result["status"] in {PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_single_digest_with_control_divergence():
    probes = [{"status_code": 500, "body": '{"digest":"abc"}', "headers": {}, "body_snippet": '{"digest":"abc"}'} for _ in range(2)]
    control = [{"status_code": 500, "body": '{"digest":"def"}', "headers": {}, "body_snippet": '{"digest":"def"}'}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
        control_results=control,
        react_major=19,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_multi_action_server_actions_errors_expected():
    probes = [{"status_code": 500, "body": "action not found", "headers": {}, "body_snippet": "action not found"}]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=True,
        server_actions_expected=True,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_multi_action_prototype_errors_without_actions():
    probes = [
        {"status_code": 400, "body": "prototype chain", "headers": {}, "body_snippet": "prototype chain"},
        {"status_code": 400, "body": "prototype crash", "headers": {}, "body_snippet": "prototype crash"},
    ]
    result = multi_action.analyze_multi_action_results(
        probes,
        framework="nextjs",
        is_rsc_framework=False,
        server_actions_expected=None,
    )
    assert result["status"] in {PocStatus.LIKELY_VULNERABLE, PocStatus.VULNERABLE}


def test_analyze_waku_results_no_surface_and_empty_responses():
    result = waku_interpreter.analyze_waku_results([], endpoints=[])
    assert result["status"] == PocStatus.NOT_APPLICABLE

    empty_result = waku_interpreter.analyze_waku_results(
        [{"status_code": 500, "body": "", "body_snippet": "", "headers": {}, "endpoint": "/RSC/F/abc/action.txt"}],
        endpoints=[("/RSC/F/abc/action.txt", "action")],
        react_major=18,
    )
    assert empty_result["status"] in {PocStatus.NOT_VULNERABLE, PocStatus.LIKELY_NOT_VULNERABLE}


def test_analyze_waku_results_detects_patch_and_vuln():
    patched_probe = [
        {
            "status_code": 200,
            "body": "$T1: reference",
            "body_snippet": "$T1: reference",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        }
    ]
    patched = waku_interpreter.analyze_waku_results(patched_probe, endpoints=[("/RSC/F/abc/t.txt", "t")])
    assert patched["status"] == PocStatus.LIKELY_NOT_VULNERABLE

    vuln_probe = [
        {
            "status_code": 200,
            "body": "0:{}",
            "body_snippet": "0:{}",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/u.txt",
        }
    ]
    vulnerable = waku_interpreter.analyze_waku_results(vuln_probe, endpoints=[("/RSC/F/abc/u.txt", "u")])
    assert vulnerable["status"] == PocStatus.VULNERABLE


def test_analyze_waku_results_control_comparison():
    probe_results = [
        {
            "status_code": 500,
            "body": "formData.get is not a function",
            "body_snippet": "formData.get is not a function",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        },
    ]
    control_results = [
        {
            "status_code": 500,
            "body": "formData.get is not a function",
            "body_snippet": "formData.get is not a function",
            "headers": {"content-type": "text/x-component"},
            "endpoint": "/RSC/F/abc/t.txt",
        },
    ]
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/t.txt", "t")],
        control_results=control_results,
    )
    assert result["status"] in {PocStatus.LIKELY_NOT_VULNERABLE, PocStatus.NOT_VULNERABLE}


def test_analyze_waku_results_success_without_t():
    probe_results = [
        {"status_code": 200, "body": "0:{}", "body_snippet": "0:{}", "headers": {"content-type": "text/x-component"}, "endpoint": "/RSC/F/abc/u.txt"},
    ]
    result = waku_interpreter.analyze_waku_results(
        probe_results,
        endpoints=[("/RSC/F/abc/u.txt", "u")],
        react_major=19,
    )
    assert result["status"] in {PocStatus.VULNERABLE, PocStatus.LIKELY_VULNERABLE}


def test_poc_journal_trims_and_serializes():
    journal = PocJournal(entry_limit_bytes=64, max_entries=2)
    journal.add_event("step", "summary", data={"key": "value"})
    journal.add_event("probe", "long" * 50, data="x" * 200)
    journal.add_decision("status", "done")
    entries = journal.to_list()
    assert len(entries) == 2 or entries[-1]["step"] == "journal-truncated"
    assert entries[0]["step"] == "step"
