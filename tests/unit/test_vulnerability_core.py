from reactguard.errors import ErrorCategory
from reactguard.models import FrameworkDetectionResult, ScanRequest
from reactguard.models.poc import PocStatus
from reactguard.vulnerability_detection.registry import get_applicable_pocs, poc_registry
from reactguard.vulnerability_detection.runner import CVE202555182VulnerabilityDetector, VulnerabilityDetectionRunner


class StubAssessor:
    def __init__(self, status):
        self.status = status
        self.calls = 0

    def evaluate(self, *_, **__):
        self.calls += 1
        return {"status": self.status, "details": {"cve_id": "CVE-2025-55182", "reason": "stub"}, "raw_data": {}}


def test_registry_filters_by_tags():
    registry = poc_registry()
    assert any(p.name == "cve-2025-55182" for p in registry)
    applicable = get_applicable_pocs(["nextjs", "unknown"])
    assert len(applicable) == 1


def test_detector_handles_fetch_error_and_non_applicable():
    detection_error = FrameworkDetectionResult(tags=[], signals={"fetch_error_category": ErrorCategory.TIMEOUT.value})
    detector = CVE202555182VulnerabilityDetector()
    inconclusive = detector.evaluate("http://example", detection_result=detection_error)
    assert inconclusive["status"] == PocStatus.INCONCLUSIVE

    detection_none = FrameworkDetectionResult(tags=[], signals={"detection_confidence": 10})
    not_applicable = detector.evaluate("http://example", detection_result=detection_none)
    assert not_applicable["status"] == PocStatus.NOT_APPLICABLE


def test_detector_delegates_to_assessor(monkeypatch):
    detection = FrameworkDetectionResult(tags=["waku"], signals={"detection_confidence": 70})
    detector = CVE202555182VulnerabilityDetector()
    stub = StubAssessor(PocStatus.VULNERABLE)
    detector.assessors["waku"] = stub
    result = detector.evaluate("http://example", detection_result=detection)
    assert result["status"] == PocStatus.VULNERABLE
    assert stub.calls == 1


def test_vulnerability_runner_detects_when_missing_detection(monkeypatch):
    detection_called = {"count": 0}

    class FakeEngine:
        def detect(self, request: ScanRequest):
            detection_called["count"] += 1
            return FrameworkDetectionResult(tags=["nextjs"], signals={})

    runner = VulnerabilityDetectionRunner(detection_engine=FakeEngine())

    monkeypatch.setattr(
        runner.detector,
        "evaluate",
        lambda *args, **kwargs: {"status": PocStatus.LIKELY_NOT_VULNERABLE, "details": {"cve_id": "CVE-2025-55182"}, "raw_data": {}},
    )

    result = runner.run("http://example")
    assert detection_called["count"] == 1
    assert result["status"] == PocStatus.LIKELY_NOT_VULNERABLE
